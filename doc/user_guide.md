## Parquet2MBT 用户指南（详细参数手册）

本指南为 `parquet2mbt` 的所有命令行参数提供详尽的解释和使用示例，主要面向需要精细化控制转换过程的高级用户。

---

### 参数详细说明

#### 1. 必需参数

- **`--input-dir <PATH>`**
  - **说明**: 指定包含Parquet文件的输入目录，工具会递归扫描此目录下的所有文件。
  - **示例**: `--input-dir /mnt/data/my_corpus`

- **`--tokenizer <PATH>`**
  - **说明**: HuggingFace `tokenizer.json` 或 SentencePiece `.model` 文件的路径。这是执行分词的核心依赖。
  - **示例**: `--tokenizer /path/to/my_tokenizer.json`

- **`--output-prefix <PATH>`**
  - **说明**: 输出文件的前缀。工具会基于此前缀生成 `.bin` 和 `.idx` 文件。
  - **示例**: `--output-prefix /mnt/output/my_dataset` (将生成 `my_dataset.bin` 和 `my_dataset.idx`)

---

#### 2. 基础配置

- **`--pattern <GLOB>`**
  - **说明**: 用于匹配输入目录中文件的glob模式。
  - **默认值**: `*.parquet`
  - **示例**:
    - 匹配Snappy压缩的Parquet文件: `--pattern "*.snappy.parquet"`
    - 匹配特定分区: `--pattern "year=2024/*.parquet"`

- **`--batch-size <INT>`**
  - **说明**: 流水线中每个批次处理的记录（行）数。较大的批次可以提高吞吐量，但会增加内存消耗。
  - **默认值**: `8192`
  - **示例**: `--batch-size 16384`

- **`--dtype <TYPE>`**
  - **说明**: 输出 `.bin` 文件中Token ID的数据类型。
  - **可选值**:
    - `auto`: 根据tokenizer的词汇表大小自动选择（<65535用`u16`，否则用`i32`）。
    - `u16`: 强制使用16位无符号整数。
    - `i32`: 强制使用32位有符号整数（兼容旧版Megatron）。
  - **默认值**: `auto`
  - **示例**: `--dtype u16`

- **`--doc-boundary <TYPE>`**
  - **说明**: 定义文档的边界。这影响 `.idx` 文件的生成方式。
  - **可选值**:
    - `row`: 将Parquet文件中的每一行视为一个独立的文档。
    - `file`: 将整个Parquet文件视为一个单独的文档。
  - **默认值**: `row`
  - **示例**: `--doc-boundary file`

- **`--concat-sep <STR>`**
  - **说明**: 当拼接多列文本时使用的分隔符。
  - **默认值**: `\n` (换行符)
  - **示例**: 使用两个换行符作为分隔: `--concat-sep "\n\n"`

- **`--metrics-interval <SEC>`**
  - **说明**: 在标准输出中打印性能指标的时间间隔（秒）。设置为 `0` 可以禁用此功能。
  - **默认值**: `5`
  - **示例**: 每10秒更新一次指标: `--metrics-interval 10`

- **`--target-shard-size-mb <MB>`**
  - **说明**: 输出文件分片的目标大小（MB）。当一个 `.bin` 文件达到此大小后，写入器会自动关闭当前文件并创建新的分片文件。
  - **默认值**: `2048`
  - **示例**: `--target-shard-size-mb 4096`

---

#### 3. 并行处理配置

系统会根据CPU核心数自动进行“智能分配”，一般无需手动配置。以下参数仅供高级用户在特殊场景下进行微调。

- **`--workers <INT>`**
  - **说明**: 流水线使用的总工作线程数。
  - **默认值**: 系统CPU核心数。
  - **示例**: `--workers 64`

- **`--read-workers <INT>`**
  - **说明**: 专门用于读取Parquet文件的工作线程数。
  - **默认值**: 根据“智能分配”策略决定（通常为2-4个）。
  - **示例**: `--read-workers 4`

- **`--tokenize-workers <INT>`**
  - **说明**: 专门用于文本分词的工作线程数。这是CPU密集型任务，通常分配绝大部分核心。
  - **默认值**: 根据“智能分配”策略决定。
  - **示例**: `--tokenize-workers 60`

- **`--write-workers <INT>`**
  - **说明**: 专门用于将处理好的数据写入 `.bin` 和 `.idx` 文件的工作线程数。
  - **默认值**: 根据“智能分配”策略决定（通常为1-2个）。
  - **示例**: `--write-workers 2`

- **`--queue-cap <INT>`**
  - **说明**: 流水线各阶段之间缓冲队列的容量。
  - **默认值**: `32`
  - **示例**: `--queue-cap 16`

---

#### 4. 高级功能

- **`--no-write`**
  - **说明**: 启用测试模式，执行除文件写入外的所有步骤（读取、预处理、分词）。用于性能分析和瓶颈定位。
  - **示例**: `--no-write`

---

### 环境变量

- **`RUST_LOG`**
  - **说明**: 控制日志的详细级别。
  - **可选值**: `error`, `warn`, `info`, `debug`, `trace`
  - **示例**: `RUST_LOG=debug ./target/release/parquet2mbt ...`

---

### 工作线程分配策略（智能分配）

默认情况下，用户无需关心 `--read-workers`, `--tokenize-workers`, `--write-workers` 的具体数值。系统会基于当前环境的CPU核心数，应用经过性能测试验证的分层自适应策略，以达到最优性能。

- **0-32核**: 2读取 + 1写入 + (N-3)分词
- **33-64核**: 3读取 + 1写入 + (N-4)分词
- **65-96核**: 4读取 + 2写入 + (N-6)分词
- **97-160核**: 6读取 + 2写入 + (N-8)分词
- **160+核**: 按优化比例分配

**只有在明确知道系统瓶颈并需要手动调优时，才建议手动指定worker数量来覆盖此自动策略。**



